<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://mvaldes14.github.io/blog/static/css/styles.css"
    />
    <link
      rel="shortcut icon"
      href="https://mvaldes14.github.io/blog/static/images/blog_logo.png"
      type="image/x-icon"
    />
    <title>Dev Mex</title>
  </head>

  <body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-title" href="https://mvaldes14.github.io/blog">
          <strong class="title">
            <img
              src="https://mvaldes14.github.io/blog/static/images/blog_logo.png"
              width="25px"
            />
            Dev Mex
          </strong>
          <span>
            <p class="subtitle">IT Things.</p>
          </span>
        </a>
      </div>
      <div class="navbar-end">
        <div class="has-text-centered">
          <a href="https://github.com/mvaldes14" target="blank">
            <img
              class="navbar-icon"
              src="https://mvaldes14.github.io/blog/static/images/github-circle.png"
              width="50px"
            />
          </a>
          <a href="https://twitter.com/rorixrebel" target="blank">
            <img
              class="navbar-icon"
              src="https://mvaldes14.github.io/blog/static/images/twitter-circle.png"
              width="50px"
            />
          </a>
          <a
            href="https://www.linkedin.com/in/miguel-valdes-0476155b/"
            target="blank"
          >
            <img
              class="navbar-icon"
              src="https://mvaldes14.github.io/blog/static/images/linkedin-box.png"
              width="50px"
            />
          </a>
        </div>
      </div>
    </nav>


<div class="container article-page">
  <hr />
  <h1 class="title">My Home Docker&nbsp;Setup</h1>
  <div class="breadcrumb">
    <ul>
      <strong>
        <span>In:&nbsp</span>
      </strong>
      <li>Containers</li>
      <li class="is-active">March 04, 2020</li>
    </ul>
    <span class="tag is-small is-dark"> docker </span>
  </div>
  <article class="content"><p>Recently decided to migrate all of the things that I run on my personal computer and a little server I got for Xmas (originally for <span class="caps">PLEX</span>) as well as my raspberry pi to docker containers so that I could experiment more with it and boy, not as easy as I thought it was going to&nbsp;be.</p>
<p>Most of the applications had specific configuration files in a location that needed to be mounted somewhere, then I had to think of which apps to move to which node cause of the resources on each node, setup the permissions and respective volumes depending on the usage, all in all, it was fun and I learned a&nbsp;lot.</p>
<p>One last thing was that I knew very little how the networking aspect worked so I had to create networks between some of these so that I could have communication between them. For instance, the Kibana instance for my elastic cluster has a cross-cluster search so I can visualize the data from both clusters in a single pane so I had to figure out how to make these connections to each&nbsp;other.</p>
<p><strong><span class="caps">NOTE</span>: Everything in here is using Docker <span class="caps">SWARM</span>, so make sure you have your swarm&nbsp;setup.</strong></p>
<h2 id="containers">Containers:</h2>
<p><strong>Elasticsearch&nbsp;clusters</strong></p>
<ul>
<li>
<p>Home cluster - for things I play with (trump twitter data, couple indices that are used for an app I’m working on, etc.). The home cluster comes with an instance of Logstash and Kibana&nbsp;respectfully.</p>
</li>
<li>
<p>Server cluster - for reading data that is being generated by a script I made (mostly to keep track of my internet speed, pihole logs), this cluster consists of a gateway node and a data node. One receives the traffic, the other one keeps the&nbsp;data.</p>
</li>
</ul>
<p><strong>Guacamole</strong></p>
<ul>
<li>Used to remote access my servers that are online&nbsp;24/7.</li>
</ul>
<p><strong>Kafka <span class="amp">&amp;</span>&nbsp;Zookeeper</strong></p>
<ul>
<li>Been playing with it a lot lately, not much else to say. Definitely a cool&nbsp;tool.</li>
</ul>
<p><strong><span class="caps">LDAP</span></strong></p>
<ul>
<li>I wanted to have some of my services use this as an authentication backend but haven’t had the time to create the schemas and add users, but its&nbsp;running.</li>
</ul>
<p><strong>Media</strong></p>
<ul>
<li>Couple containers to keep track of series and <span class="caps">TV</span> shows I watch ( sonarr, radarr, jackett&nbsp;)</li>
</ul>
<p><strong>MySQL</strong></p>
<ul>
<li>Local database so I can dump data sets for me to play&nbsp;with.</li>
</ul>
<p><strong>Organizr</strong></p>
<ul>
<li>An excellent application that allows you to manage all of your bookmarks, so now I can just click on an icon and I’m taken to a&nbsp;container.</li>
</ul>
<p><strong>Portainer</strong></p>
<ul>
<li>Used to manage most of my stack, sometimes the GUIs are better than the&nbsp;terminal.</li>
</ul>
<p><strong>Prometheus <span class="amp">&amp;</span>&nbsp;Grafana</strong></p>
<ul>
<li>To collect and graph all of the metrics from my&nbsp;systems.</li>
</ul>
<p><strong>Traefik</strong></p>
<ul>
<li>Reverse proxy for my containers, no longer have to remember IPs and&nbsp;ports.</li>
</ul>
<p>Got couple more services running on the servers but due to hardware constraints, mostly video decoding for plex, those remain as system processes that I can turn on/off when&nbsp;needed.</p>
<p>Same as my PiHole, I found that its easier to just keep it running on my raspberry pi. Might move it to a container soon using&nbsp;mcvlan.</p>
<h2 id="setup">Setup</h2>
<p>Most containers need couple gigs of storage and some don’t require a thing as long as they have a mount for the config file so based on that I ended up creating a couple of mount points as&nbsp;follows:</p>
<ol>
<li><code>/opt/elasticsearch</code> <code>50GB</code> on both home and server nodes to allocate the index&nbsp;data.</li>
<li><code>/opt/prometheus</code> <code>1GB</code> to hold the <code>prometheus.yml</code> required for the scrape targets as well as hosting the time series data collected, by default I have it to only collect a week worth of&nbsp;metrics.</li>
<li><code>/opt/kafka</code> <code>500MB</code> for all of the topic data, couple gigs, nothing&nbsp;special.</li>
<li><code>/opt/grafana</code> <code>150MB</code> to hold the configuration data, one key thing for this one is that the mount point has to be owned by a unique <span class="caps">ID</span> for it to work properly, something odd but to be on the lookout&nbsp;for.</li>
<li><code>/opt/media</code> <code>250MB</code> for all of the configurations created by the containers cause I didn&#8217;t want to setup APIs every time i needed those&nbsp;services.</li>
<li><code>/opt/mysql</code> <code>500MB</code> to hold all of my local&nbsp;databases.</li>
</ol>
<h3 id="networks">Networks</h3>
<p>The final step was to figure out a way for some of these to talk to each other, was going to use <span class="caps">NGINX</span> but kept seeing “Traefik” in Reddit so I figured I’d give it a shot…. after couple hours of trying and reading, got it to work in a way that makes sense to me and best of all I could integrate it perfectly with <code>organizr</code>.</p>
<p>Traefik requires you to run all of the containers you want to route the traffic to be on the same network, which is easy with&nbsp;docker.</p>
<div class="highlight"><pre><span></span><code><span class="err">docker network create traefik-proxy --driver overlay</span>
</code></pre></div>


<p>With that setup, all you have to do is define the network in your compose&nbsp;files.</p>
<h3 id="compose-files">Compose&nbsp;Files</h3>
<p>Since I have a bunch of containers and to give you an idea I’m only going to show you couple examples, if you would like to see all configs feel free to reach out on social media (details at the&nbsp;bottom).</p>
<p>As a reminder, I got 3 Nodes in Docker Swarm mode with node labels so that I can force docker to run the containers on specific nodes based on the hardware requirements behind&nbsp;them.</p>
<div class="highlight"><pre><span></span><code>$ docker node inspect manjaro-server <span class="p">|</span> jq .<span class="o">[</span><span class="m">0</span><span class="o">]</span>.Spec.Labels.name
<span class="s2">&quot;server&quot;</span>
$ docker node inspect manjaro-home <span class="p">|</span> jq .<span class="o">[</span><span class="m">0</span><span class="o">]</span>.Spec.Labels.name
<span class="s2">&quot;home&quot;</span>
$ docker node inspect pi <span class="p">|</span> jq .<span class="o">[</span><span class="m">0</span><span class="o">]</span>.Spec.Labels.name
<span class="s2">&quot;pi&quot;</span>
</code></pre></div>


<p><strong>Traefik</strong></p>
<p>The documentation suggests you run traefik on your master node so it can control and view all of the container events so I&#8217;ve forced it to run on the manager node all the&nbsp;time.</p>
<div class="highlight"><pre><span></span><code><span class="k">version</span><span class="p">:</span> <span class="ss">&quot;3.7&quot;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">traefik</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">traefik</span><span class="p">:</span><span class="n">v2</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">networks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">traefik</span><span class="o">-</span><span class="n">proxy</span>
    <span class="n">command</span><span class="p">:</span>
      <span class="o">-</span> <span class="c1">--entrypoints.metrics.address=:8082</span>
      <span class="o">-</span> <span class="c1">--entrypoints.http.address=:80</span>
      <span class="o">-</span> <span class="c1">--api.dashboard=true</span>
      <span class="o">-</span> <span class="c1">--api.insecure=true</span>
      <span class="o">-</span> <span class="c1">--providers.docker</span>
      <span class="o">-</span> <span class="c1">--providers.docker.swarmMode=true</span>
      <span class="o">-</span> <span class="c1">--providers.docker.exposedByDefault=false</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="mi">80</span><span class="p">:</span><span class="mi">80</span>
      <span class="o">-</span> <span class="mi">8080</span><span class="p">:</span><span class="mi">8080</span>
      <span class="o">-</span> <span class="mi">8082</span><span class="p">:</span><span class="mi">8082</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="n">sock</span>
    <span class="n">deploy</span><span class="p">:</span>
      <span class="n">placement</span><span class="p">:</span>
        <span class="k">constraints</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">node</span><span class="p">.</span><span class="k">role</span> <span class="o">==</span> <span class="n">manager</span>

<span class="n">networks</span><span class="p">:</span>
  <span class="n">traefik</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span>
    <span class="k">external</span><span class="p">:</span> <span class="k">true</span>
</code></pre></div>


<p><strong>Guacamole</strong></p>
<p>Running this as well on the node that is 24/7 so i can access it remotely whenever i&nbsp;want.</p>
<div class="highlight"><pre><span></span><code><span class="k">version</span><span class="p">:</span> <span class="ss">&quot;3.7&quot;</span>
<span class="n">services</span><span class="p">:</span>
  <span class="n">guacamole</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">oznu</span><span class="o">/</span><span class="n">guacamole</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">guacamole</span><span class="p">:</span><span class="o">/</span><span class="n">config</span>
    <span class="n">networks</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">traefik</span><span class="o">-</span><span class="n">proxy</span>
    <span class="n">deploy</span><span class="p">:</span>
      <span class="n">placement</span><span class="p">:</span>
        <span class="k">constraints</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">node</span><span class="p">.</span><span class="n">labels</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">server</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="o">-</span> <span class="ss">&quot;traefik.enable=true&quot;</span>
        <span class="o">-</span> <span class="ss">&quot;traefik.http.routers.guacamole.entrypoints=http&quot;</span>
        <span class="o">-</span> <span class="ss">&quot;traefik.http.routers.guacamole.rule=Host(`guacamole.local.net`)&quot;</span>
        <span class="o">-</span> <span class="ss">&quot;traefik.http.services.guacamole.loadbalancer.server.port=8080&quot;</span>
        <span class="o">-</span> <span class="ss">&quot;traefik.docker.network=traefik-proxy&quot;</span>

<span class="n">networks</span><span class="p">:</span>
  <span class="n">traefik</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span>
    <span class="k">external</span><span class="p">:</span> <span class="k">true</span>
</code></pre></div>


<h2 id="conclusion">Conclusion</h2>
<p>With a couple compose files pushed to a private <span class="caps">GIT</span> repo (mostly for sensitive data on the configurations, need to learn how to use docker secrets) my stack is fully automated, now with an ansible playbook I can have the same setup in&nbsp;minutes.</p>
<p>Again, this was a long task and I did learn a lot on how to debug and troubleshoot mostly networking problems with containers and being my first real project that used docker-compose it was good&nbsp;fun.</p>
<p>I hope you liked it, until next time,&nbsp;Adios.</p></article>
  <hr />
</div>

  </body>
</html>